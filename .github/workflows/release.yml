name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Get version
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Build binaries
      run: |
        # Create release directory
        mkdir -p release
        
        # Build flags
        VERSION=${{ steps.version.outputs.VERSION }}
        COMMIT_HASH=$(git rev-parse --short HEAD)
        BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
        LDFLAGS="-X main.version=${VERSION} -X main.commit=${COMMIT_HASH} -X main.buildTime=${BUILD_TIME} -s -w"
        
        # Build for different platforms
        platforms=(
          "linux/amd64"
          "linux/arm64"
          "darwin/amd64"
          "darwin/arm64"
          "windows/amd64"
          "windows/arm64"
        )
        
        for platform in "${platforms[@]}"; do
          IFS='/' read -r GOOS GOARCH <<< "$platform"
          
          case $GOOS in
            "linux")
              OS_NAME="Linux"
              ;;
            "darwin")
              OS_NAME="Darwin"
              ;;
            "windows")
              OS_NAME="Windows"
              ;;
          esac
          
          case $GOARCH in
            "amd64")
              ARCH_NAME="x86_64"
              ;;
            "arm64")
              ARCH_NAME="arm64"
              ;;
          esac
          
          output_name="claudeproxy_${OS_NAME}_${ARCH_NAME}"
          if [ $GOOS = "windows" ]; then
            output_name+='.exe'
          fi
          
          echo "Building for $GOOS/$GOARCH -> $output_name"
          
          env GOOS=$GOOS GOARCH=$GOARCH CGO_ENABLED=0 go build \
            -ldflags="${LDFLAGS}" \
            -o release/${output_name} \
            main.go
        done
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        name: Claude Code Proxy ${{ steps.version.outputs.VERSION }}
        body: |
          # Claude Code Proxy ${{ steps.version.outputs.VERSION }}
          
          ## ğŸ‰ æ–°ç‰¹æ€§
          - æä¾› OpenAI å…¼å®¹çš„ API æ¥å£
          - æ”¯æŒ Claude 3.5 Sonnet æ¨¡å‹
          - æ”¯æŒæµå¼å“åº”
          - æ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼
          
          ## ğŸ“¦ å®‰è£…æ–¹å¼
          
          ### å¿«é€Ÿå®‰è£…ï¼ˆæ¨èï¼‰
          
          **Linux/macOS:**
          ```bash
          sudo curl -o /usr/local/bin/claudeproxy -L https://github.com/${{ github.repository }}/releases/latest/download/claudeproxy_`uname -s`_`uname -m`
          sudo chmod +x /usr/local/bin/claudeproxy
          ```
          
          **Windows (PowerShell):**
          ```powershell
          Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/latest/download/claudeproxy_Windows_x86_64.exe" -OutFile "claudeproxy.exe"
          ```
          
          ### ä½¿ç”¨å®‰è£…è„šæœ¬
          ```bash
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
          ```
          
          ### æ‰‹åŠ¨ä¸‹è½½
          
          é€‰æ‹©é€‚åˆæ‚¨ç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
          
          - **Linux x86_64**: claudeproxy_Linux_x86_64
          - **Linux ARM64**: claudeproxy_Linux_arm64
          - **macOS Intel**: claudeproxy_Darwin_x86_64
          - **macOS Apple Silicon**: claudeproxy_Darwin_arm64
          - **Windows x86_64**: claudeproxy_Windows_x86_64.exe
          - **Windows ARM64**: claudeproxy_Windows_arm64.exe
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. é…ç½® API å¯†é’¥ï¼š
             ```bash
             claudeproxy setup
             ```
          
          2. å¯åŠ¨æœåŠ¡ï¼š
             ```bash
             claudeproxy start
             ```
          
          3. ä½¿ç”¨ OpenAI å…¼å®¹çš„ APIï¼š
             ```bash
             curl -X POST http://localhost:8080/v1/chat/completions \
               -H "Content-Type: application/json" \
               -H "Authorization: Bearer your-api-key" \
               -d '{
                 "model": "claude-3-5-sonnet-20241022",
                 "messages": [
                   {"role": "user", "content": "Hello!"}
                 ]
               }'
             ```
          
          ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          - æ“ä½œç³»ç»Ÿ: Linux, macOS, Windows
          - æ¶æ„: x86_64, ARM64
          - ç½‘ç»œ: éœ€è¦è®¿é—® Anthropic API
          
          ## ğŸ”§ é…ç½®è¯´æ˜
          
          è¯¦ç»†é…ç½®è¯´æ˜è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£ã€‚
          
          ---
          
          **å®Œæ•´æºä»£ç **: https://github.com/${{ github.repository }}
          **é—®é¢˜åé¦ˆ**: https://github.com/${{ github.repository }}/issues
          **ä½¿ç”¨æ–‡æ¡£**: https://github.com/${{ github.repository }}/blob/main/README.md
        files: |
          release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
